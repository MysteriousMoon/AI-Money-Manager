// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Transaction {
  id                  String      @id @default(uuid())
  userId              String
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount              Float
  currencyCode        String      @default("CNY")
  categoryId          String?
  date                String      // Storing as ISO string YYYY-MM-DD for simplicity, or DateTime
  note                String?
  merchant            String?
  type                String      // 'EXPENSE' | 'INCOME' | 'TRANSFER'
  source              String      // 'MANUAL' | 'AI_SCAN' | 'RECURRING'
  accountId           String?     // Account for this transaction
  account             Account?    @relation("AccountTransactions", fields: [accountId], references: [id], onDelete: SetNull)
  transferToAccountId String?     // For TRANSFER type: destination account
  transferToAccount   Account?    @relation("TransferToAccount", fields: [transferToAccountId], references: [id], onDelete: SetNull)
  targetAmount        Float?      // For transfers with currency exchange
  targetCurrencyCode  String?     // For transfers with currency exchange
  fee                 Float?      // Transaction fee
  feeCurrencyCode     String?     // Currency for the fee
  investmentId        String?     // Optional: linked investment for tracking
  investment          Investment? @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  
  // New: Project Attribution
  projectId           String?
  project             Project?    @relation(fields: [projectId], references: [id], onDelete: SetNull)
   
  // Suggested: Exclude from "Cost of Living" analytics?
  excludeFromAnalytics Boolean    @default(false)
  
  // v3.0: Split Transaction Support
  splitParentId        String?    // Links to parent transaction for split attribution
  splitParent          Transaction? @relation("SplitChildren", fields: [splitParentId], references: [id], onDelete: Cascade)
  splitChildren        Transaction[] @relation("SplitChildren")

  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([investmentId])
  @@index([splitParentId])
  @@map("transactions")
}

model Category {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  icon      String
  type      String   // 'EXPENSE' | 'INCOME'
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("categories")
}

model RecurringRule {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  amount       Float
  currencyCode String   @default("CNY")
  categoryId   String
  merchant     String?
  accountId    String?  // Account for this recurring rule
  account      Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  frequency    String   // 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'YEARLY'
  interval     Int      @default(1)
  startDate    String
  lastRunDate  String?
  nextRunDate  String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([accountId])
  @@map("recurring_rules")
}

model Settings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiBaseUrl         String   @default("https://api.openai.com/v1")
  apiKey             String?
  model              String   @default("gpt-4o")
  currency           String   @default("CNY")
  exchangeRateApiKey String?
  language           String   @default("en")
  theme              String   @default("system")
  defaultAccountId   String?  // Default payment account
  updatedAt          DateTime @updatedAt

  @@map("settings")
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  password       String          @default("123456")
  name           String?
  role           String          @default("USER") // 'ADMIN' | 'USER'
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  transactions   Transaction[]
  categories     Category[]
  recurringRules RecurringRule[]
  investments    Investment[]
  accounts       Account[]
  projects       Project[]
  settings       Settings?

  @@map("users")
}

model Investment {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  type          String   // 'STOCK' | 'DEPOSIT' | 'FUND' | 'ASSET' | 'OTHER'
  initialAmount Float
  currentAmount Float?   // For tracking market value
  currencyCode  String   @default("CNY")
  interestRate  Float?   // For deposits (e.g., 2.5 for 2.5%)
  accountId     String?
  account       Account? @relation(fields: [accountId], references: [id], onDelete: SetNull)
  startDate     String
  endDate       String?
  status        String   @default("ACTIVE") // 'ACTIVE' | 'CLOSED' | 'WRITTEN_OFF'
  note          String?
  
  // v3.0: Write-off Support
  writtenOffDate   String?  // Date when asset was written off
  writtenOffReason String?  // Reason for write-off (e.g., "Broken", "Lost", "Obsolete")
  
  // Fixed Asset Depreciation Fields
  depreciationType       String?  // 'STRAIGHT_LINE' | 'DECLINING_BALANCE' | null
  usefulLife             Int?     // Useful life in years
  salvageValue           Float?   // Salvage value (residual value)
  purchasePrice          Float?   // For fixed assets
  lastDepreciationDate String? // Date of last recorded depreciation
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[] // Related transactions
  
  // New: Project Attribution
  projectId     String?
  project       Project?      @relation(fields: [projectId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@map("investments")
}

model Account {
  id                    String          @id @default(uuid())
  userId                String
  user                  User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                  String
  type                  String          // 'BANK' | 'DIGITAL_WALLET' | 'CASH' | 'CREDIT_CARD' | 'INVESTMENT' | 'OTHER'
  initialBalance        Float           @default(0)
  currencyCode          String          @default("CNY")
  color                 String?         // For UI distinction (e.g., #FF5733)
  icon                  String?         // Emoji or icon identifier
  isDefault             Boolean         @default(false)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  transactions          Transaction[]   @relation("AccountTransactions")
  transfersTo           Transaction[]   @relation("TransferToAccount")
  recurringRules        RecurringRule[]
  investments           Investment[]

  @@index([userId])
  @@map("accounts")
}

model Project {
  id          String    @id @default(uuid())
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
   
  name        String    // e.g. "Hokkaido Trip", "Full-time Job", "Side Hustle - Photography"
  type        String    // 'TRIP' | 'JOB' | 'SIDE_HUSTLE' | 'EVENT'
  status      String    @default("ACTIVE") // 'ACTIVE' | 'COMPLETED' | 'ARCHIVED'
   
  startDate   String    // ISO Date YYYY-MM-DD
  endDate     String?   // Jobs might not have an end date, but trips do
   
  totalBudget Float?    // Budget (Optional)
   
  // Relations
  transactions Transaction[]
  investments  Investment[]  // Linked Assets (e.g., equipment bought specifically for this project)

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@map("projects")
}

// Global system settings (admin-managed)
model SystemSettings {
  id                 String   @id @default("default")
  exchangeRateApiKey String?
  updatedAt          DateTime @updatedAt
  updatedBy          String?  // Admin user ID who last updated

  @@map("system_settings")
}
