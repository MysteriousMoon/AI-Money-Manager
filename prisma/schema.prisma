// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Transaction {
  id           String      @id @default(uuid())
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount       Float
  currencyCode String      @default("CNY")
  categoryId   String
  date         String      // Storing as ISO string YYYY-MM-DD for simplicity, or DateTime
  note         String?
  merchant     String?
  type         String      // 'EXPENSE' | 'INCOME'
  source       String      // 'MANUAL' | 'AI_SCAN' | 'RECURRING'
  investmentId String?     // Optional: linked investment for tracking
  investment   Investment? @relation(fields: [investmentId], references: [id], onDelete: Cascade)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  @@index([userId])
  @@index([investmentId])
  @@map("transactions")
}

model Category {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String
  icon      String
  type      String   // 'EXPENSE' | 'INCOME'
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@map("categories")
}

model RecurringRule {
  id           String   @id @default(uuid())
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name         String
  amount       Float
  currencyCode String   @default("CNY")
  categoryId   String
  merchant     String?
  frequency    String   // 'DAILY' | 'WEEKLY' | 'MONTHLY' | 'YEARLY'
  interval     Int      @default(1)
  startDate    String
  lastRunDate  String?
  nextRunDate  String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@map("recurring_rules")
}

model Settings {
  id                 String   @id @default(uuid())
  userId             String   @unique
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  apiBaseUrl         String   @default("https://api.openai.com/v1")
  apiKey             String?
  model              String   @default("gpt-4o")
  currency           String   @default("CNY")
  exchangeRateApiKey String?
  language           String   @default("en")
  theme              String   @default("system")
  updatedAt          DateTime @updatedAt

  @@map("settings")
}

model User {
  id             String          @id @default(uuid())
  email          String          @unique
  password       String          @default("123456")
  name           String?
  role           String          @default("USER") // 'ADMIN' | 'USER'
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  transactions   Transaction[]
  categories     Category[]
  recurringRules RecurringRule[]
  investments    Investment[]
  settings       Settings?

  @@map("users")
}

model Investment {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  type          String   // 'STOCK' | 'DEPOSIT' | 'FUND' | 'OTHER'
  initialAmount Float
  currentAmount Float?   // For tracking market value
  currencyCode  String   @default("CNY")
  interestRate  Float?   // For deposits (e.g., 2.5 for 2.5%)
  startDate     String
  endDate       String?
  status        String   @default("ACTIVE") // 'ACTIVE' | 'CLOSED'
  note          String?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[] // Related transactions

  @@index([userId])
  @@map("investments")
}
